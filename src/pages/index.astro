---
/** index.astro — Astro 5 + Tailwind
 * - SSR: en PROD llamamos a /api/* vía 127.0.0.1:PORT (sin salir a internet ni pasar por Caddy/SSL)
 * - En DEV usamos el origin de la request (Vite dev server)
 * - Muestra errores verbosos en UI y loguea en servidor
 */

interface LinkItem {
    title: string;
    subtitle?: string;
    url: string;
}
interface LinkGroup {
    name: string;
    links: LinkItem[];
}
interface LinksData {
    title?: string;
    groups?: LinkGroup[];
}

const isProd = import.meta.env.PROD === true;
const port = (isProd ? (process.env.PORT ?? "3000") : "") as string;

// En producción: pega directo al propio contenedor (evita DNS/HTTPS).
// En dev: usa el origin real de la request.
const baseOrigin = isProd
    ? `http://127.0.0.1:${port}`
    : new URL(Astro.request.url).origin;

let links: LinksData = { title: "Accesos rápidos", groups: [] };
let stats = {
    month: { label: "", total: 0 },
    week: { label: "", total: 0 },
    day: { label: "", total: 0 },
};
let linksOk = false;
let statsOk = false;
let linksErr = "";
let statsErr = "";

// Helper SSR para hacer fetch con logs y errores explícitos
async function loadJSON(path: string) {
    const url = new URL(path, baseOrigin).toString();
    try {
        const res = await fetch(url, {
            method: "GET",
            headers: { Accept: "application/json" },
            // evita caches en proxy/navegador
            cache: "no-store",
        });
        if (!res.ok) {
            const text = await res.text().catch(() => "");
            const msg = `HTTP ${res.status} ${res.statusText} :: ${text.slice(0, 300)}`;
            console.error("[index] Fetch not OK:", url, msg);
            return { __error: msg };
        }
        return await res.json();
    } catch (err: any) {
        const msg = String(err?.message ?? err);
        console.error("[index] Fetch error:", url, msg);
        return { __error: msg };
    }
}

try {
    const [linksData, statsData] = await Promise.all([
        loadJSON("/api/links"),
        loadJSON("/api/fiscalizaciones"),
    ]);

    if ((linksData as any)?.__error) {
        linksErr = (linksData as any).__error;
    } else {
        links = linksData as LinksData;
        linksOk = true;
    }

    if ((statsData as any)?.__error) {
        statsErr = (statsData as any).__error;
    } else {
        stats = statsData as typeof stats;
        statsOk = true;
    }
} catch (e: any) {
    // fallback por si algo explota fuera de los fetch
    const msg = e?.message ?? String(e);
    console.error("[index] Unhandled:", msg);
    linksErr ||= `links error: ${msg}`;
    statsErr ||= `stats error: ${msg}`;
}
---

<html lang="es" class="h-full">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <title>{links.title ? `${links.title} — Homepage` : "Homepage"}</title>
        <link rel="icon" href="data:," />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
            rel="stylesheet"
        />
    </head>

    <body
        class="min-h-full bg-ink-950 text-slate-200"
        style="font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;"
    >
        <main class="w-full px-4 py-6">
            <!-- Top bar simple -->
            <div class="mx-auto mb-6 flex max-w-[1400px] items-center gap-4">
                <div
                    class="flex items-center gap-2 rounded-xl bg-ink-900 px-3 py-1.5 shadow-[inset_0_1px_0_rgba(255,255,255,0.04)] ring-1 ring-white/5"
                >
                    <span
                        class="inline-flex h-6 w-6 items-center justify-center rounded-md bg-ink-800 text-xs font-medium"
                        >YOB</span
                    >
                    <nav class="flex gap-4 text-sm text-slate-400">
                        <span class="font-medium text-slate-200">Inicio</span>
                    </nav>
                </div>
            </div>

            <!-- CONTENEDOR 1: KPIs -->
            <section class="mx-auto max-w-[1400px]">
                <header class="mb-4">
                    <h1 class="text-2xl font-semibold">
                        {links.title ?? "Accesos rápidos"}
                    </h1>
                    <p class="text-slate-400">
                        Panel compacto para enlaces frecuentes y métricas del
                        mes
                    </p>
                </header>

                <div
                    class="rounded-2xl bg-ink-900 p-4 shadow-card ring-1 ring-white/10"
                >
                    <div class="mb-4 flex items-center justify-between">
                        <h3
                            class="text-xs uppercase tracking-wide text-slate-400"
                        >
                            Fiscalizaciones
                        </h3>
                        <span
                            class="rounded-full bg-ink-850 px-2 py-0.5 text-[0.72rem] leading-5 tracking-wide ring-1 ring-white/10 text-slate-300"
                        >
                            Base de datos
                        </span>
                    </div>

                    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                        <!-- Mes -->
                        <div
                            class="rounded-xl bg-ink-850 p-4 ring-1 ring-white/5"
                        >
                            <p
                                class="text-[0.72rem] leading-5 tracking-wide text-slate-400"
                            >
                                Este mes
                            </p>
                            <p
                                class="mt-1 text-3xl font-semibold text-slate-100"
                            >
                                {stats.month.total ?? 0}
                            </p>
                            <p
                                class="mt-1 text-[0.72rem] leading-5 tracking-wide text-slate-400"
                            >
                                {stats.month.label}
                            </p>
                        </div>
                        <!-- Semana -->
                        <div
                            class="rounded-xl bg-ink-850 p-4 ring-1 ring-white/5"
                        >
                            <p
                                class="text-[0.72rem] leading-5 tracking-wide text-slate-400"
                            >
                                Esta semana
                            </p>
                            <p
                                class="mt-1 text-3xl font-semibold text-slate-100"
                            >
                                {stats.week.total ?? 0}
                            </p>
                            <p
                                class="mt-1 text-[0.72rem] leading-5 tracking-wide text-slate-400"
                            >
                                {stats.week.label}
                            </p>
                        </div>
                        <!-- Día -->
                        <div
                            class="rounded-xl bg-ink-850 p-4 ring-1 ring-white/5"
                        >
                            <p
                                class="text-[0.72rem] leading-5 tracking-wide text-slate-400"
                            >
                                Hoy
                            </p>
                            <p
                                class="mt-1 text-3xl font-semibold text-slate-100"
                            >
                                {stats.day.total ?? 0}
                            </p>
                            <p
                                class="mt-1 text-[0.72rem] leading-5 tracking-wide text-slate-400"
                            >
                                {stats.day.label}
                            </p>
                        </div>
                    </div>

                    {
                        !statsOk && (
                            <p class="mt-3 text-xs text-rose-300/80">
                                No se pudo cargar{" "}
                                <code>/api/fiscalizaciones</code>. {statsErr}
                            </p>
                        )
                    }
                </div>
            </section>

            <div class="h-6"></div>

            <!-- CONTENEDOR 2: Links desde YAML -->
            <section class="mx-auto max-w-[1400px]">
                <div
                    class="rounded-2xl bg-ink-900 p-4 shadow-card ring-1 ring-white/10"
                >
                    <div class="mb-3 flex items-center justify-between">
                        <h3
                            class="text-xs uppercase tracking-wide text-slate-400"
                        >
                            Atajos útiles
                        </h3>
                        <span class="text-xs text-slate-400">
                            edita en <code class="text-slate-300"
                                >data/links.yaml</code
                            >
                        </span>
                    </div>

                    {
                        links.groups?.length ? (
                            links.groups.map((group) => (
                                <section class="mb-5 last:mb-0">
                                    <h4 class="mb-2 text-sm font-medium text-slate-300">
                                        {group.name}
                                    </h4>
                                    <div class="grid gap-3 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4">
                                        {group.links?.map((card) => (
                                            <a
                                                href={card.url}
                                                target="_blank"
                                                rel="noopener"
                                                class="group rounded-xl bg-ink-850 p-4 ring-1 ring-white/5 transition hover:bg-ink-800"
                                            >
                                                <h5 class="line-clamp-1 font-medium text-slate-200">
                                                    {card.title}
                                                </h5>
                                                {card.subtitle && (
                                                    <p class="mt-1 text-[0.72rem] leading-5 tracking-wide text-slate-400">
                                                        {card.subtitle}
                                                    </p>
                                                )}
                                                <span class="mt-2 inline-block opacity-0 transition group-hover:opacity-100">
                                                    ➜
                                                </span>
                                            </a>
                                        ))}
                                    </div>
                                </section>
                            ))
                        ) : (
                            <p class="text-slate-400">
                                Agrega tus enlaces en{" "}
                                <code class="text-slate-300">
                                    data/links.yaml
                                </code>
                                .
                            </p>
                        )
                    }

                    {
                        !linksOk && (
                            <p class="mt-3 text-xs text-rose-300/80">
                                No se pudo cargar <code>/api/links</code>.{" "}
                                {linksErr}
                            </p>
                        )
                    }
                </div>
            </section>
        </main>
    </body>
</html>
