---
/** index.astro — Astro 5 + Tailwind v3
 * - Arriba: fila con 3 KPIs (mes/semana/día) casi a todo ancho
 * - Abajo: contenedor con tarjetas leídas desde YAML (/api/links)
 * - Fix importante: fetch con URL absoluta usando Astro.request.url
 */
interface LinkItem {
    title: string;
    subtitle?: string;
    url: string;
}
interface LinkGroup {
    name: string;
    links: LinkItem[];
}
interface LinksData {
    title?: string;
    groups?: LinkGroup[];
}

let links: LinksData = { title: "Accesos rápidos", groups: [] };
let stats = {
    month: { label: "", total: 0 },
    week: { label: "", total: 0 },
    day: { label: "", total: 0 },
};
let linksOk = false;
let statsOk = false;
let linksErr = "";
let statsErr = "";

try {
    const linksURL = new URL("/api/links", Astro.request.url);
    const statsURL = new URL("/api/fiscalizaciones", Astro.request.url);

    const [resLinks, resStats] = await Promise.all([
        fetch(linksURL),
        fetch(statsURL),
    ]);

    if (resLinks.ok) {
        links = await resLinks.json();
        linksOk = true;
    } else {
        linksErr = `GET /api/links -> ${resLinks.status} ${resLinks.statusText}`;
    }

    if (resStats.ok) {
        stats = await resStats.json();
        statsOk = true;
    } else {
        statsErr = `GET /api/fiscalizaciones -> ${resStats.status} ${resStats.statusText}`;
    }
} catch (e: any) {
    linksErr ||= `links error: ${e?.message ?? String(e)}`;
    statsErr ||= `stats error: ${e?.message ?? String(e)}`;
}
---

<html lang="es" class="h-full">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <title>{links.title ? `${links.title} — Homepage` : "Homepage"}</title>
        <link rel="icon" href="data:," />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
            rel="stylesheet"
        />
    </head>

    <body
        class="min-h-full bg-ink-950 text-slate-200"
        style="font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;"
    >
        <main class="w-full px-4 py-6">
            <!-- Top bar simple -->
            <div class="mx-auto mb-6 flex max-w-[1400px] items-center gap-4">
                <div
                    class="flex items-center gap-2 rounded-xl bg-ink-900 px-3 py-1.5 shadow-[inset_0_1px_0_rgba(255,255,255,0.04)] ring-1 ring-white/5"
                >
                    <span
                        class="inline-flex h-6 w-6 items-center justify-center rounded-md bg-ink-800 text-xs font-medium"
                        >G</span
                    >
                    <nav class="flex gap-4 text-sm text-slate-400">
                        <span class="font-medium text-slate-200">Inicio</span>
                        <span class="hover:text-slate-200">Gestión</span>
                        <span class="hover:text-slate-200">Sistemas</span>
                        <span class="hover:text-slate-200">Soporte</span>
                    </nav>
                </div>
            </div>

            <!-- CONTENEDOR 1: KPIs a casi todo el ancho -->
            <section class="mx-auto max-w-[1400px]">
                <header class="mb-4">
                    <h1 class="text-2xl font-semibold">
                        {links.title ?? "Accesos rápidos"}
                    </h1>
                    <p class="text-slate-400">
                        Panel compacto para enlaces frecuentes y métricas del
                        mes
                    </p>
                </header>

                <div
                    class="rounded-2xl bg-ink-900 p-4 shadow-card ring-1 ring-white/10"
                >
                    <div class="mb-4 flex items-center justify-between">
                        <h3
                            class="text-xs uppercase tracking-wide text-slate-400"
                        >
                            Fiscalizaciones
                        </h3>
                        <span
                            class="rounded-full bg-ink-850 px-2 py-0.5 text-[0.72rem] leading-5 tracking-wide ring-1 ring-white/10 text-slate-300"
                        >
                            Supabase
                        </span>
                    </div>

                    <!-- Fila de 3 tarjetas -->
                    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                        <!-- Mes -->
                        <div
                            class="rounded-xl bg-ink-850 p-4 ring-1 ring-white/5"
                        >
                            <p
                                class="text-[0.72rem] leading-5 tracking-wide text-slate-400"
                            >
                                Este mes
                            </p>
                            <p
                                class="mt-1 text-3xl font-semibold text-slate-100"
                            >
                                {stats.month.total ?? 0}
                            </p>
                            <p
                                class="mt-1 text-[0.72rem] leading-5 tracking-wide text-slate-400"
                            >
                                {stats.month.label}
                            </p>
                        </div>
                        <!-- Semana -->
                        <div
                            class="rounded-xl bg-ink-850 p-4 ring-1 ring-white/5"
                        >
                            <p
                                class="text-[0.72rem] leading-5 tracking-wide text-slate-400"
                            >
                                Esta semana
                            </p>
                            <p
                                class="mt-1 text-3xl font-semibold text-slate-100"
                            >
                                {stats.week.total ?? 0}
                            </p>
                            <p
                                class="mt-1 text-[0.72rem] leading-5 tracking-wide text-slate-400"
                            >
                                {stats.week.label}
                            </p>
                        </div>
                        <!-- Día -->
                        <div
                            class="rounded-xl bg-ink-850 p-4 ring-1 ring-white/5"
                        >
                            <p
                                class="text-[0.72rem] leading-5 tracking-wide text-slate-400"
                            >
                                Hoy
                            </p>
                            <p
                                class="mt-1 text-3xl font-semibold text-slate-100"
                            >
                                {stats.day.total ?? 0}
                            </p>
                            <p
                                class="mt-1 text-[0.72rem] leading-5 tracking-wide text-slate-400"
                            >
                                {stats.day.label}
                            </p>
                        </div>
                    </div>

                    <!-- Debug opcional si falla el fetch de stats -->
                    {
                        !statsOk && (
                            <p class="mt-3 text-xs text-rose-300/80">
                                No se pudo cargar /api/fiscalizaciones.{" "}
                                {statsErr}
                            </p>
                        )
                    }
                </div>
            </section>

            <!-- Espacio -->
            <div class="h-6"></div>

            <!-- CONTENEDOR 2: Tarjetas desde YAML -->
            <section class="mx-auto max-w-[1400px]">
                <div
                    class="rounded-2xl bg-ink-900 p-4 shadow-card ring-1 ring-white/10"
                >
                    <div class="mb-3 flex items-center justify-between">
                        <h3
                            class="text-xs uppercase tracking-wide text-slate-400"
                        >
                            Atajos útiles
                        </h3>
                        <span class="text-xs text-slate-400"
                            >edita en <code class="text-slate-300"
                                >data/links.yaml</code
                            ></span
                        >
                    </div>

                    {
                        links.groups?.length ? (
                            links.groups.map((group) => (
                                <section class="mb-5 last:mb-0">
                                    <h4 class="mb-2 text-sm font-medium text-slate-300">
                                        {group.name}
                                    </h4>
                                    <div class="grid gap-3 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4">
                                        {group.links?.map((card) => (
                                            <a
                                                href={card.url}
                                                target="_blank"
                                                rel="noopener"
                                                class="group rounded-xl bg-ink-850 p-4 ring-1 ring-white/5 transition hover:bg-ink-800"
                                            >
                                                <h5 class="line-clamp-1 font-medium text-slate-200">
                                                    {card.title}
                                                </h5>
                                                {card.subtitle && (
                                                    <p class="mt-1 text-[0.72rem] leading-5 tracking-wide text-slate-400">
                                                        {card.subtitle}
                                                    </p>
                                                )}
                                                <span class="mt-2 inline-block opacity-0 transition group-hover:opacity-100">
                                                    ➜
                                                </span>
                                            </a>
                                        ))}
                                    </div>
                                </section>
                            ))
                        ) : (
                            <p class="text-slate-400">
                                Agrega tus enlaces en{" "}
                                <code class="text-slate-300">
                                    data/links.yaml
                                </code>
                                .
                            </p>
                        )
                    }

                    {
                        !linksOk && (
                            <p class="mt-3 text-xs text-rose-300/80">
                                No se pudo cargar /api/links. {linksErr}
                            </p>
                        )
                    }
                </div>
            </section>
        </main>
    </body>
</html>
